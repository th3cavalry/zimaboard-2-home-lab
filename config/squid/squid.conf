# Squid Proxy Configuration for ZimaBoard 2 Cellular Network
# Optimized for gaming, streaming, and general web caching

# Basic configuration
http_port 3128
visible_hostname zimaboard-cache

# Cache directory configuration
cache_dir ufs /var/spool/squid 40000 16 256
cache_mem 512 MB
maximum_object_size_in_memory 8 MB
maximum_object_size 1 GB

# Cache storage optimization for cellular network
cache_replacement_policy lru
memory_replacement_policy lru

# Access control lists
acl localnet src 192.168.0.0/16
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src fc00::/7
acl localnet src fe80::/10

# Safe ports
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

# Gaming platform ports (Steam, Epic, Origin, etc.)
acl Gaming_ports port 27000-27100  # Steam
acl Gaming_ports port 3478-3480    # Steam Voice
acl Gaming_ports port 4379-4380    # Steam
acl Gaming_ports port 27015-27030  # Steam servers
acl Gaming_ports port 7777-7784    # Epic Games
acl Gaming_ports port 17503        # Origin
acl Gaming_ports port 42127        # Origin
acl Gaming_ports port 3216         # Origin
acl Gaming_ports port 9988         # Origin
acl Gaming_ports port 17500        # Origin
acl Gaming_ports port 42127        # Origin

# Streaming services optimization
acl Streaming_domains dstdomain .netflix.com .youtube.com .twitch.tv .hulu.com .disney.com .amazon.com .primevideo.com .hbomax.com .spotify.com .apple.com

# Gaming platforms
acl Gaming_domains dstdomain .steampowered.com .steamcontent.com .steamstatic.com .epicgames.com .origin.com .ea.com .battle.net .blizzard.com .riotgames.com .leagueoflegends.com .valorant.com

# CDN and update servers
acl CDN_domains dstdomain .akamai.net .cloudflare.com .cloudfront.net .fastly.com .cdn.com .edgecast.com .limelight.com

# Software update domains
acl Update_domains dstdomain .windowsupdate.com .microsoft.com .apple.com .ubuntu.com .debian.org .fedoraproject.org

# CONNECT method rules
acl CONNECT method CONNECT

# Access rules
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny CONNECT !Gaming_ports
http_access allow localnet
http_access allow localhost
http_access deny all

# Caching rules for different content types

# Gaming content - cache for longer periods
refresh_pattern -i \.(pak|vpk|wad|pk3|pk4|gcf|ncf|vdf)$ 43200 80% 259200 override-expire ignore-no-cache ignore-private

# Game updates and patches
refresh_pattern -i steam.*/(depot|chunk) 43200 80% 259200 override-expire ignore-no-cache
refresh_pattern -i epic.*/(chunk|manifest) 43200 80% 259200 override-expire ignore-no-cache
refresh_pattern -i origin.*/(patch|update) 43200 80% 259200 override-expire ignore-no-cache

# Streaming video segments (optimized for buffering)
refresh_pattern -i \.(ts|m4s|mp4|webm|mkv)$ 10080 80% 43200 override-expire ignore-no-cache
refresh_pattern -i /(videoplayback|video) 10080 80% 43200 override-expire ignore-no-cache

# Images and static content
refresh_pattern -i \.(jpg|jpeg|png|gif|webp|ico|svg)$ 10080 80% 43200 override-expire ignore-no-cache
refresh_pattern -i \.(css|js|woff|woff2|ttf|eot)$ 10080 80% 43200 override-expire ignore-no-cache

# Software downloads and updates
refresh_pattern -i \.(deb|rpm|exe|msi|dmg|pkg|tar\.gz|zip|7z|rar)$ 43200 80% 259200 override-expire ignore-no-cache

# OS updates
refresh_pattern -i microsoft\.com/.*/(update|patch) 43200 80% 259200 override-expire ignore-no-cache
refresh_pattern -i apple\.com/.*/(update|software) 43200 80% 259200 override-expire ignore-no-cache
refresh_pattern -i ubuntu\.com/.*/Release 1440 80% 10080 override-expire ignore-no-cache

# CDN content
refresh_pattern -i (akamai|cloudflare|cloudfront|fastly).*\.(jpg|jpeg|png|gif|css|js|mp4|webm)$ 10080 80% 43200 override-expire ignore-no-cache

# Default patterns
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# Cache peering (for future expansion)
# icp_port 3130

# Bandwidth optimization for cellular
# Range request handling for video streaming
range_offset_limit 200 MB
quick_abort_min 0 KB
quick_abort_max 0 KB
quick_abort_pct 95

# Connection optimization
half_closed_clients off
client_lifetime 1 hour
connect_timeout 30 seconds
peer_connect_timeout 30 seconds
read_timeout 5 minutes
request_timeout 1 minute

# Memory optimization
fqdncache_size 2048
ipcache_size 2048

# Logging configuration
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
pid_filename /var/run/squid.pid

# Store log for cache analysis
cache_store_log /var/log/squid/store.log

# Error pages
error_directory /usr/share/squid/errors/English

# Coredump directory
coredump_dir /var/spool/squid

# DNS optimization
dns_nameservers 192.168.8.100 1.1.1.1 8.8.8.8
dns_timeout 30 seconds

# HTTP header optimizations
via off
forwarded_for delete
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
reply_header_access X-Cache deny all
reply_header_access X-Cache-Lookup deny all

# Cellular network optimizations
tcp_recv_bufsize 65536
read_ahead_gap 16 KB

# Cache replacement optimizations for cellular
cache_swap_low 90
cache_swap_high 95

# Gaming-specific optimizations
acl gaming_downloads url_regex -i \.(pak|vpk|wad|pk3|pk4|gcf|ncf|vdf|zip|7z|exe)$
cache_peer_access allow gaming_downloads

# Streaming optimizations
acl video_content rep_mime_type video/mp4 video/webm video/x-flv application/x-mpegURL
acl audio_content rep_mime_type audio/mpeg audio/mp4 audio/aac

# Special handling for live streams (shorter cache time)
acl live_stream url_regex -i (live|stream|playlist\.m3u8)
refresh_pattern -i (live|stream|playlist\.m3u8) 60 50% 180 ignore-no-cache override-expire

# YouTube optimization
acl youtube dstdomain .youtube.com .ytimg.com .googlevideo.com
cache_peer_access allow youtube
refresh_pattern -i youtube.*\.(flv|mp4|webm) 10080 80% 43200 override-expire ignore-no-cache ignore-private

# Steam content optimization
acl steam dstdomain .steampowered.com .steamcontent.com .steamstatic.com
refresh_pattern -i steam.*\.(pak|vpk|gcf|ncf) 43200 90% 259200 override-expire ignore-no-cache ignore-private

# Disable caching for certain content
acl no_cache url_regex -i (login|account|auth|secure|private|admin|checkout|cart|order)
cache deny no_cache

# Performance tuning
shutdown_lifetime 10 seconds
